---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mdns-bridge-script
  namespace: hass
  labels:
    app.kubernetes.io/name: home-assistant
    app.kubernetes.io/part-of: services
    app.kubernetes.io/component: mdns-bridge
data:
  bridge.py: |
    #!/usr/bin/env python3
    """
    mDNS bridge: relays multicast mDNS (224.0.0.251:5353) on the host network
    to the Home Assistant pod via unicast UDP, and vice versa.
    """

    import os
    import socket
    import struct
    import threading
    import time
    import logging

    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s [%(levelname)s] %(message)s",
    )
    log = logging.getLogger("mdns-bridge")

    MCAST_GRP = "224.0.0.251"
    MCAST_PORT = 5353
    HA_HOST = os.environ.get("HA_MDNS_HOST", "home-assistant-mdns.hass.svc.cluster.local")
    HA_PORT = int(os.environ.get("HA_MDNS_PORT", "5353"))
    # Port the bridge listens on for HA's outbound mDNS (unicast from HA)
    REVERSE_PORT = int(os.environ.get("REVERSE_PORT", "5354"))


    def multicast_to_unicast():
        """Listen for mDNS multicast on the host network and forward to HA."""
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
        sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEPORT, 1)
        sock.bind(("", MCAST_PORT))

        # Join the mDNS multicast group on all interfaces
        mreq = struct.pack("4sL", socket.inet_aton(MCAST_GRP), socket.INADDR_ANY)
        sock.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP, mreq)

        log.info("Listening for mDNS multicast on %s:%d", MCAST_GRP, MCAST_PORT)
        log.info("Forwarding to HA at %s:%d", HA_HOST, HA_PORT)

        fwd = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)

        while True:
            try:
                data, addr = sock.recvfrom(9000)
                # Skip packets from ourselves (avoid loops)
                if addr[1] == REVERSE_PORT:
                    continue
                log.debug("mDNS from %s:%d (%d bytes)", addr[0], addr[1], len(data))
                fwd.sendto(data, (HA_HOST, HA_PORT))
            except Exception:
                log.exception("Error in multicast_to_unicast")
                time.sleep(1)


    def unicast_to_multicast():
        """Listen for unicast mDNS from HA and re-broadcast as multicast."""
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
        sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        sock.bind(("", REVERSE_PORT))

        mcast = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
        mcast.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, 255)

        log.info("Listening for HA mDNS on unicast port %d", REVERSE_PORT)
        log.info("Re-broadcasting to multicast %s:%d", MCAST_GRP, MCAST_PORT)

        while True:
            try:
                data, addr = sock.recvfrom(9000)
                log.debug("HA mDNS from %s:%d (%d bytes)", addr[0], addr[1], len(data))
                mcast.sendto(data, (MCAST_GRP, MCAST_PORT))
            except Exception:
                log.exception("Error in unicast_to_multicast")
                time.sleep(1)


    if __name__ == "__main__":
        log.info("mDNS bridge starting")
        t1 = threading.Thread(target=multicast_to_unicast, daemon=True, name="mcast-to-uni")
        t2 = threading.Thread(target=unicast_to_multicast, daemon=True, name="uni-to-mcast")
        t1.start()
        t2.start()
        t1.join()
        t2.join()
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mdns-bridge
  namespace: hass
  labels:
    app.kubernetes.io/name: home-assistant
    app.kubernetes.io/part-of: services
    app.kubernetes.io/component: mdns-bridge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mdns-bridge
  template:
    metadata:
      labels:
        app: mdns-bridge
        app.kubernetes.io/name: home-assistant
        app.kubernetes.io/component: mdns-bridge
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        kubernetes.io/hostname: kube-3
      containers:
        - name: mdns-bridge
          image: python:3.14-slim
          command: ["python3", "/scripts/bridge.py"]
          env:
            - name: HA_MDNS_HOST
              value: home-assistant-mdns.hass.svc.cluster.local
            - name: HA_MDNS_PORT
              value: "5353"
            - name: REVERSE_PORT
              value: "5354"
          volumeMounts:
            - name: script
              mountPath: /scripts
              readOnly: true
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              memory: 64Mi
      volumes:
        - name: script
          configMap:
            name: mdns-bridge-script
---
apiVersion: v1
kind: Service
metadata:
  name: home-assistant-mdns
  namespace: hass
  labels:
    app.kubernetes.io/name: home-assistant
    app.kubernetes.io/part-of: services
    app.kubernetes.io/component: mdns
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/instance: home-assistant
    app.kubernetes.io/name: home-assistant
  ports:
    - name: mdns
      protocol: UDP
      port: 5353
      targetPort: 5353
