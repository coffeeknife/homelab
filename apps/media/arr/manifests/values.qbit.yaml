
qbittorrent:
  persistence:
    downloads:
      enabled: false
  extraVolumeMounts:
    - mountPath: /data
      name: jellyfin-nfs

extraVolumes:
  - name: jellyfin-nfs
    nfs:
      server: 192.168.1.69
      path: "/mnt/birdpool/jellyfin/media"

gluetun:
  settings:
    PROTONVPN_TIER: '2'
    PORT_FORWARD_ONLY: on
    VPN_PORT_FORWARDING: on
    VPN_PORT_FORWARDING_PROVIDER: protonvpn
    FIREWALL_OUTBOUND_SUBNETS: 172.16.0.0/12,192.168.0.0/16,10.1.0.0/16,10.152.183.0/24
  credentials:
    create: false
  vpn:
    provider: protonvpn
    type: wireguard
    serverCountries: Sweden
    wireguard:
      privateKeyExistingSecret: protonvpn-key
      privateKeyExistingSecretKey: private_key # made manually

sidecars:
  - name: port-sync
    image: alpine:3.21
    command: ["/bin/sh", "-c"]
    args:
      - |
        apk add --no-cache curl > /dev/null 2>&1
        LAST_PORT=""
        echo "[port-sync] Starting port forwarding sync"
        while true; do
          if [ -f /tmp/gluetun/forwarded_port ]; then
            PORT=$(cat /tmp/gluetun/forwarded_port)
            if [ -n "$PORT" ] && [ "$PORT" != "0" ] && [ "$PORT" != "$LAST_PORT" ]; then
              echo "[port-sync] Port changed: ${LAST_PORT:-none} -> ${PORT}"
              until curl -sf http://localhost:8080/api/v2/app/version > /dev/null; do
                sleep 5
              done
              curl -sf -c /tmp/cookies http://localhost:8080/api/v2/auth/login \
                -d "username=${QBIT_USER}&password=${QBIT_PASS}" > /dev/null
              HTTP=$(curl -sf -o /dev/null -w '%{http_code}' -b /tmp/cookies \
                http://localhost:8080/api/v2/app/setPreferences \
                -d "json={\"listen_port\":${PORT}}")
              if [ "$HTTP" = "200" ]; then
                echo "[port-sync] Set listening port to ${PORT}"
                LAST_PORT="$PORT"
              else
                echo "[port-sync] Failed to set port (HTTP ${HTTP})"
              fi
            fi
          fi
          sleep 60
        done
    env:
      - name: QBIT_USER
        valueFrom:
          secretKeyRef:
            name: qbit-auth
            key: QBITTORRENT_USER
      - name: QBIT_PASS
        valueFrom:
          secretKeyRef:
            name: qbit-auth
            key: QBITTORRENT_PASS
    volumeMounts:
      - name: gluetun-shared-data
        mountPath: /tmp/gluetun
        readOnly: true
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 50m
        memory: 64Mi

ingress:
  enabled: true
  className: traefik
  annotations:
    cert-manager.io/cluster-issuer: cert-issuer
    # homepage
    gethomepage.dev/enabled: "true"
    gethomepage.dev/group: "Arr"
    gethomepage.dev/app: qbittorrent-vpn
    gethomepage.dev/name: "qBittorrent"
    gethomepage.dev/icon: qbittorrent
    gethomepage.dev/description: Getting the goods.
    gethomepage.dev/widget.type: qbittorrent
    gethomepage.dev/widget.url: https://qbit.wrenspace.dev/
    gethomepage.dev/widget.username: admin
    gethomepage.dev/widget.password: EeveeReal69
  hosts:
    - host: qbit.wrenspace.dev
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: qbit-secret
      hosts:
        - qbit.wrenspace.dev